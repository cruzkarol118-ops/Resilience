<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='mas/Resilience 1.png') }}" type="image/x-icon">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='est_editar_cita.css') }}"> 
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <title>Editar Cita — RESILIENCE</title>
</head>
<body>
    <main class="main">
        <section class="section container" style="padding-top:6rem; padding-bottom:4rem;">
            
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }}">
                    <span>{{ message }}</span>
                    <button class="alert-close-btn" onclick="this.parentElement.style.display='none';">&times;</button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <h2 class="sectiontitle">Ajuste de Cita Activa</h2>
            
            <form class="form-agendar" id="form-editar-cita" action="{{ url_for('est_editar_cita', id_cita=cita_activa.ID_Cita) }}" method="POST">
                
                <h3><i class="fas fa-pencil-alt"></i> Ajustar tu Cita</h3>
                <small style="display: block; margin-top: -1rem; margin-bottom: 1rem; color: #bfb8ff;">Modifica la información y haz clic en "Guardar Cambios".</small>

                <div class="detalle-grupo">
                    <span class="detalle-label">Estado Actual</span>
                    <span class="detalle-valor {% if cita_activa.Estado_Cita == 'SOLICITADA' %}estado-solicitada{% else %}estado-confirmada{% endif %}">
                        {{ cita_activa.Estado_Cita }}
                    </span>
                </div>
                <div class="detalle-grupo">
                    <span class="detalle-label">Ubicación de Referencia</span>
                    <span class="detalle-valor">{{ cita_activa.Nota_Ubicacion if cita_activa.Nota_Ubicacion else 'Pendiente de confirmación.' }}</span>
                </div>

                <h3 style="margin-top: 2rem;"><i class="fas fa-user-graduate"></i> Tus Datos Personales</h3>
                
                <div class="form-group">
                    <label for="programa">Programa Académico*</label>
                    <input type="text" id="programa" name="programa" class="input" required
                           value="{{ cita_activa.Programa_Academico }}">
                </div>
                <div class="form-group" style="display: flex; gap: 1rem;">
                    <div style="flex: 1;">
                        <label for="semestre">Semestre*</label>
                        <input type="number" id="semestre" name="semestre" class="input" required min="1" max="12"
                               value="{{ cita_activa.Semestre }}">
                    </div>
                    <div style="flex: 2;">
                        <label for="telefono">Teléfono de Contacto*</label>
                        <input type="tel" id="telefono" name="telefono" class="input" required
                               value="{{ cita_activa.Telefono_Contacto }}">
                    </div>
                </div>

                <h3 style="margin-top: 2rem;"><i class="fas fa-calendar-alt"></i> Datos de la Cita</h3>

                <div class="form-group">
                    <label for="psicologo">Selecciona un Psicólogo*</label>
                    <select id="psicologo" name="psicologo" class="select" required>
                        <option value="">-- Elige un profesional --</option>
                        {% for psicologo in psicologos %}
                            <option value="{{ psicologo.ID_Psicologo }}" 
                                    {% if psicologo.ID_Psicologo == cita_activa.ID_Psicologo %}selected{% endif %}>
                                {{ psicologo.Nombre_Completo_Display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="fecha_cita">Selecciona la Fecha* (Actual: {{ cita_activa.Fecha_Cita.strftime('%d/%m/%Y') }})</label>
                    <input type="date" id="fecha_cita" name="fecha_cita" class="input" required 
                           value="{{ cita_activa.Fecha_Cita.strftime('%Y-%m-%d') }}">
                </div>

                <div class="form-group">
                    <label>Horarios Disponibles: (Actual: {{ cita_activa.Hora_Cita_Formateada }})</label>
                    <div id="horarios-disponibles-lista" style="display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 40px;">
                        <small id="horarios-loading" style="color: #bfb8ff; display: none;">Buscando horarios...</small>
                        <small id="horarios-prompt" style="color: #bfb8ff;">Cambia el profesional o la fecha para ver opciones. Si no cambias la cita, se mantendrá el horario actual.</small>
                    </div>
                </div>

                <input type="hidden" id="id_horario_seleccionado" name="id_horario_seleccionado" value="">

                <div class="module-actions" style="margin-top: 2rem;">
                    <button type="submit" class="btn action-btn" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                    <a class="btn action-btn-outline" href="{{ url_for('agenda') }}" style="flex: 1; background: #555;">
                        Volver
                    </a>
                </div>
            </form>
            
            <form action="{{ url_for('cancelar_cita', id_cita=cita_activa.ID_Cita) }}" method="POST" 
                  onsubmit="return confirm('¿Estás seguro de que deseas cancelar esta cita? Esta acción es irreversible.');"
                  class="form-agendar" style="margin-top: 1rem; padding-top: 1rem; padding-bottom: 1rem;">
                <div class="module-actions">
                    <button type="submit" class="btn action-btn-danger" style="width: 100%;">
                        <i class="fas fa-trash-alt"></i> Cancelar Cita
                    </button>
                </div>
            </form>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('form-editar-cita');
            if (!form) return; 
            
            const psicologoSelect = document.getElementById('psicologo');
            const fechaInput = document.getElementById('fecha_cita');
            const horariosContainer = document.getElementById('horarios-disponibles-lista');
            const hiddenInputHorario = document.getElementById('id_horario_seleccionado');
            const prompt = document.getElementById('horarios-prompt');
            const loading = document.getElementById('horarios-loading');
            
            // Inicialización de variables de cita actual para validación en JS
            // Se usa String() para asegurar que el dato sea manejable incluso si es None
            const psicologoOriginal = parseInt("{{ cita_activa.ID_Psicologo | default(0) }}");
            const fechaOriginal = "{{ cita_activa.Fecha_Cita.strftime('%Y-%m-%d') | default('') }}";
            
            async function fetchHorarios() {
                const idPsicologo = psicologoSelect.value;
                const fecha = fechaInput.value;
                
                // Si cambiamos los selectores, reseteamos el valor oculto
                hiddenInputHorario.value = ''; 

                if (!idPsicologo || !fecha) {
                    prompt.style.display = 'block';
                    horariosContainer.innerHTML = ''; 
                    horariosContainer.appendChild(prompt);
                    return;
                }
                
                prompt.style.display = 'none';
                loading.style.display = 'block';
                horariosContainer.innerHTML = ''; 
                horariosContainer.appendChild(loading);
                
                try {
                    const response = await fetch(`/api/horarios/${idPsicologo}/${fecha}`);
                    if (!response.ok) throw new Error('Error al buscar horarios.');
                    const bloques = await response.json();
                    
                    loading.style.display = 'none';
                    horariosContainer.innerHTML = ''; 
                    
                    if (bloques.length === 0) {
                        horariosContainer.innerHTML = '<small style="color: #ffc107;">No hay horarios disponibles para esta combinación.</small>';
                        return;
                    }
                    
                    // Renderizar botones de horario
                    bloques.forEach(bloque => {
                        const btn = document.createElement('button');
                        btn.type = 'button'; 
                        btn.className = 'btn action-btn-outline'; 
                        btn.textContent = bloque.texto; 
                        btn.dataset.idHorario = bloque.id; 
                        
                        btn.addEventListener('click', function() {
                            document.querySelectorAll('#horarios-disponibles-lista button').forEach(b => b.style.background = 'transparent');
                            this.style.background = '#6f3be6';
                            hiddenInputHorario.value = this.dataset.idHorario;
                        });
                        horariosContainer.appendChild(btn);
                    });

                } catch (error) {
                    console.error('Error en fetchHorarios:', error);
                    loading.style.display = 'none';
                    horariosContainer.innerHTML = '<small style="color: #dc3545;">Error al cargar horarios. Intente de nuevo.</small>';
                }
            }
            
            psicologoSelect.addEventListener('change', fetchHorarios);
            fechaInput.addEventListener('change', fetchHorarios);
            
            // Validación al enviar el formulario: Requiere selección de horario si la cita cambia
            form.addEventListener('submit', function(e) {
                
                const psicologoActual = parseInt(psicologoSelect.value);
                const fechaActual = fechaInput.value;
                const horarioSeleccionado = hiddenInputHorario.value;

                // Si hay cambio en el Psicólogo O la Fecha
                if (psicologoActual !== psicologoOriginal || fechaActual !== fechaOriginal) {
                    // Y NO se ha seleccionado un nuevo horario
                    if (!horarioSeleccionado) {
                        e.preventDefault();
                        alert('Si cambias el Profesional o la Fecha, debes seleccionar un Horario Disponible de la lista para confirmar la nueva hora.');
                    }
                }
            });
        });
    </script>
</body>
</html>