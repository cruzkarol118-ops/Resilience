<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Resultados con Gráficas</title>
  <link rel="shortcut icon" href="{{ url_for('static', filename='mas/Resilience 1.png') }}" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background-color: #cb6bf7;
      color: white;
      min-height: 100vh;
      padding: 20px 0;
    }

    .resultados-container { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 30px; 
      justify-content: center;
      padding: 0 15px;
    }

    .user-info {
        text-align: center;
        margin-bottom: 5px;
        padding: 10px;
        border-bottom: 1px solid #cb6bf7;
    }
        
    .user-info i {
        margin-right: 8px;
        color: white;
    }
    
    .tema-caja { 
      border: none;
      border-radius: 10px; 
      padding: 20px; 
      width: 45%; 
      min-width: 300px; 
      background: #050027;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      color: white;
    }

    .tema-caja h3 { 
      margin: 0 0 15px 0; 
      text-transform: capitalize;
      color: white;
      border-bottom: 2px solid #6a11cb;
      padding-bottom: 8px;
    }

    .nivel { 
      font-weight: bold; 
      margin-bottom: 8px; 
      color: white;
    }

    .recomendacion { 
      font-style: italic; 
      color: #ccc;
      margin-bottom: 15px;
      padding: 10px;
      background-color: rgba(255,255,255,0.08);
      border-radius: 5px;
    }

    .chart-container {
      height: 250px;
      min-height: 150px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .volver-btn {
      display: block;
      margin: 30px auto;
      padding: 10px 25px;
      background-color: #6a11cb;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      width: fit-content;
      transition: all 0.3s;
    }

    .volver-btn:hover {
      background-color: #4a0d8a;
      transform: translateY(-2px);
    }

    .titulo-resultados {
      text-align: center;
      margin-bottom: 30px;
      color: white;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      font-size: 2.5em;
      font-weight: bold;
    }

    .no-resultados-mensaje {
        text-align: center; 
        padding: 50px; 
        background-color: #050027;
        border-radius: 10px; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: white;
    }
  </style>
</head>
<body>
  <h1 class="titulo-resultados" data-aos="zoom-in" data-aos-duration="1000">Mis Resultados</h1>
    <!-- Información del usuario -->
        <div class="user-info">
            <h4>
                <i class="fas fa-user"></i> {{ session.usuario.nombres }} {{ session.usuario.apellidos }}
                <small class="d-block mt-2">
                    <i class="fas fa-envelope"></i> {{ session.usuario.email }}
                </small>
            </h4>
        </div>
  {% if resultados %}
    <div class="resultados-container">
      {% for resultado in resultados %}
        <div class="tema-caja">
          <h3>{{ resultado.tema.replace('_', ' ') }}</h3>
          <div class="puntaje-total">Puntaje total: {{ resultado.analisis.puntaje_total }}</div>
          <div class="nivel">Nivel: {{ resultado.analisis.nivel }}</div>
          <div class="recomendacion">{{ resultado.analisis.recomendacion }}</div>
          
          <div class="chart-container">
            <canvas id="chart-{{ loop.index }}"></canvas>
            </div>

          <script type="application/json" id="data-{{ loop.index }}">
            {
              "detalles": {{ resultado.analisis.detalles | tojson }}
            }
          </script>
        </div>
      {% endfor %}
    </div>

    <a href="{{ url_for('Masculino') }}" class="volver-btn">Volver al Menú Principal</a>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        Chart.register(ChartDataLabels);

        document.querySelectorAll('script[type="application/json"]').forEach((script, i) => {
          try {
            const rawData = JSON.parse(script.textContent);
            
            // Filtramos los detalles para incluir solo los que tienen un peso significativo (mayor que 0)
            // Y también excluimos explícitamente el peso -1 de preguntas de texto libre.
            const filteredDetails = rawData.detalles.filter(d => d.peso > 0); 

            // Si no hay datos válidos para graficar (es decir, ningún peso > 0), no creamos la gráfica.
            if (filteredDetails.length === 0) {
                console.warn(`No hay datos significativos (peso > 0) para graficar en el tema ${i+1}.`);
                const canvas = document.getElementById(`chart-${i+1}`);
                if (canvas) {
                    const parentDiv = canvas.closest('.chart-container');
                    if (parentDiv) {
                        parentDiv.innerHTML = '<p style="color: #777; margin: 0;">No hay datos relevantes para mostrar en la gráfica de este tema.</p>';
                    }
                }
                return; 
            }

            const labels = filteredDetails.map((_, index) => `P${index + 1}`);
            const pesos = filteredDetails.map(d => d.peso);
            const maxPeso = Math.max(4, ...pesos); // Eje Y de la grafica

            const ctx = document.getElementById(`chart-${i+1}`).getContext('2d');
            
            // Determinar colores basados en los valores
            const backgroundColors = pesos.map(peso => {
              if (peso >= 3) return 'rgba(220, 53, 69, 0.6)'; // Rojo para valores altos
              if (peso >= 1) return 'rgba(255, 193, 7, 0.6)'; // Amarillo para valores medios
              return 'rgba(40, 167, 69, 0.6)'; // Verde para valores bajos
            });

            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Peso',
                  data: pesos,
                  backgroundColor: backgroundColors,
                  borderColor: backgroundColors.map(c => c.replace('0.6', '1')),
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true,
                    max: maxPeso,
                    ticks: {
                      stepSize: 1,
                      precision: 0,
                      color: 'white' /* Color de las etiquetas del eje Y */
                    },
                    grid: { 
                        color: 'rgba(255, 255, 255, 0.1)' /* Color de las líneas de la cuadrícula del eje Y */
                    }
                  },
                  x: {
                    grid: {
                      display: false /* Quitamos las líneas de la cuadrícula del eje X */
                    },
                    ticks: { 
                        color: 'white' /* Color de las etiquetas del eje X */
                    }
                  }
                },
                plugins: {
                  legend: { 
                    display: false 
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        return `Peso: ${context.raw}`;
                      }
                    },
                    backgroundColor: '#333',
                    titleColor: 'white',
                    bodyColor: 'white'
                  },
                  datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: 'white',
                    font: { 
                      weight: 'bold',
                      size: 10 
                    },
                    formatter: function(value) {
                      return value > 0 ? value : '';
                    }
                  }
                }
              },
              plugins: [ChartDataLabels]
            });

          } catch (e) {
            console.error('Error creando gráfica:', e);
          }
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init();
    </script>
  {% else %}
    <div class="no-resultados-mensaje">
      <p style="font-size: 1.2em; margin-bottom: 20px;">No tienes resultados para mostrar.</p>
      <a href="{{ url_for('Masculino') }}" class="volver-btn">Volver al Menú Principal</a>
    </div>
  {% endif %}
</body>
</html>